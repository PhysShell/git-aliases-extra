name: Publish

on:
  workflow_dispatch:
  push:
    tags:
      - 'v*'

jobs:
  publish:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate Module Version Against Tag
        if: startsWith(github.ref, 'refs/tags/v')
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path .\GitAliases.Extras.psd1 -ErrorAction Stop
          $tagVersion = '${{ github.ref_name }}'.TrimStart('v')
          if ($manifest.Version.ToString() -ne $tagVersion) {
            throw "Manifest version '$($manifest.Version)' does not match tag version '$tagVersion'."
          }

      - name: Install PowerShellGet
        shell: pwsh
        run: |
          if (-not (Get-PackageProvider -Name NuGet -ErrorAction SilentlyContinue)) {
            Install-PackageProvider -Name NuGet -MinimumVersion 2.8.5.201 -Scope CurrentUser -Force
          }
          Set-PSRepository PSGallery -InstallationPolicy Trusted
          Install-Module PowerShellGet -Scope CurrentUser -Force

      - name: Publish to PSGallery
        shell: pwsh
        env:
          PSGALLERY_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: |
          if (-not $env:PSGALLERY_API_KEY) {
            throw "PSGALLERY_API_KEY secret is not set."
          }

          $manifest = Test-ModuleManifest -Path .\GitAliases.Extras.psd1 -ErrorAction Stop
          $moduleName = $manifest.Name
          $moduleVersion = $manifest.Version.ToString()

          $published = Find-Module -Name $moduleName -Repository PSGallery -ErrorAction SilentlyContinue |
            Where-Object { $_.Version.ToString() -eq $moduleVersion }

          if ($published) {
            Write-Host "Version $moduleVersion is already published. Skipping Publish-Module."
            exit 0
          }

          Publish-Module -Path . -Repository PSGallery -NuGetApiKey $env:PSGALLERY_API_KEY -Verbose
